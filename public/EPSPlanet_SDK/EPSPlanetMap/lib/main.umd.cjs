(function(h,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(h=typeof globalThis<"u"?globalThis:h||self,c(h.main={}))})(this,function(h){var D,I,N,M,O,W,L,_,R,E,V,et,U,mt,H,ft,T,Q,$,F,ut,X,it,k,wt,Y,st,J,yt,G,bt,P,S,A,K,vt,ht,u,x,B,j,y,C,lt;"use strict";var Lt=Object.defineProperty;var _t=(h,c,g)=>c in h?Lt(h,c,{enumerable:!0,configurable:!0,writable:!0,value:g}):h[c]=g;var w=(h,c,g)=>(_t(h,typeof c!="symbol"?c+"":c,g),g),tt=(h,c,g)=>{if(!c.has(h))throw TypeError("Cannot "+g)};var o=(h,c,g)=>(tt(h,c,"read from private field"),g?g.call(h):c.get(h)),d=(h,c,g)=>{if(c.has(h))throw TypeError("Cannot add the same private member more than once");c instanceof WeakSet?c.add(h):c.set(h,g)},p=(h,c,g,q)=>(tt(h,c,"write to private field"),q?q.call(h,g):c.set(h,g),g);var m=(h,c,g)=>(tt(h,c,"access private method"),g);const c="";class g{static loadScript(s,t=!1){return new Promise(e=>{if(s===""){e(!1);return}const i=document.createElement("script");i.type="text/javascript",i.async=!1,i.onload=()=>{i.remove(),e(!0)},i.onerror=()=>{i.remove(),e(!1)},t&&(i.type="module"),i.src=s,document.head.append?document.head.append(i):document.getElementsByTagName("head")[0].appendChild(i)})}static loadCSS(s){return new Promise(t=>{if(s===""){t(!1);return}const e=document.createElement("link");e.rel="stylesheet",e.href=s,e.onload=()=>{t(!0)},e.onerror=()=>{t(!1)},document.head.append?document.head.append(e):document.getElementsByTagName("head")[0].appendChild(e)})}static async loadJSON(s){return await(await fetch(s)).json()}}const q=async()=>{const r=window.isDebug;let s="configs/setting.json";r&&(s="configs/debug.json");const t=await g.loadJSON(s);let e=[];t.include.forEach(i=>{t.modules[i].forEach(a=>{switch(a.type){case"css":e.push(g.loadCSS(a.url));break;case"js":e.push(g.loadScript(a.url));break;case"module":e.push(g.loadScript(a.url,!0));break}})}),await Promise.all(e)};class nt extends HTMLElement{constructor(){super();d(this,D,void 0);p(this,D,this.innerHTML.trim())}get origin(){return o(this,D)}}D=new WeakMap,customElements.define("w-l",nt);var v=(r=>(r[r.none=0]="none",r[r.funOnly=1]="funOnly",r[r.propOnly=2]="propOnly",r[r.always=3]="always",r))(v||{});const ot=r=>s=>(s.prototype._manifest=St(r),customElements.define(r.tagName,s),s),St=r=>(r=Object.assign({hasConfig:!1,mode:v.always},r),r),rt=r=>{Promise?Promise.resolve().then(r):requestAnimationFrame?requestAnimationFrame(r):setTimeout(r,0)};class at extends HTMLElement{constructor(){super();d(this,V);d(this,U);d(this,H);d(this,T);d(this,F);d(this,X);d(this,k);d(this,Y);d(this,J);d(this,G);d(this,S);d(this,I,void 0);d(this,N,void 0);d(this,M,void 0);d(this,O,void 0);d(this,W,void 0);d(this,L,void 0);d(this,_,"w-l");d(this,R,!1);d(this,E,void 0);d(this,$,!1);d(this,P,"unInited");this.manifest.hasConfig&&m(this,V,et).call(this,this.getAttribute("config")||this.getAttribute("configUrl")),p(this,E,this.manifest.mode??v.always),rt(()=>{m(this,H,ft).call(this),m(this,S,A).call(this)})}startup(t){this.mapView=t.mapView,this.map=t.map,this.mapConfig=t.mapConfig,this.config=t.config}get manifest(){return this._manifest}get mapConfig(){return o(this,I)}set mapConfig(t){!o(this,I)&&t&&(p(this,I,t),m(this,S,A).call(this))}get mapView(){return o(this,N)}set mapView(t){!o(this,N)&&t&&(p(this,N,t),m(this,S,A).call(this))}get map(){return o(this,M)}set map(t){!o(this,M)&&t&&(p(this,M,t),m(this,S,A).call(this))}get config(){return o(this,O)}set config(t){if(typeof t=="string"){m(this,V,et).call(this,t);return}else typeof t=="object"&&!o(this,O)&&t&&(p(this,O,t),m(this,S,A).call(this))}get loading(){return!!o(this,W)}set loading(t){p(this,W,t),m(this,U,mt).call(this)}get $data(){return o(this,L)}set $data(t){(o(this,E)&v.propOnly)==v.propOnly?(p(this,L,m(this,T,Q).call(this,t)),m(this,X,it).call(this)):p(this,L,t)}isReady(){return!!(this.map&&this.mapView&&this.mapConfig&&(this.config||!this.manifest.hasConfig))}async onInit(){}afterInit(){}onOpen(){}onClose(){}}I=new WeakMap,N=new WeakMap,M=new WeakMap,O=new WeakMap,W=new WeakMap,L=new WeakMap,_=new WeakMap,R=new WeakMap,E=new WeakMap,V=new WeakSet,et=async function(t){if(!this.config&&t){this.loading=!0;const e=await fetch(t);this.config=e&&e.ok&&await e.json()||{},this.loading=!1}},U=new WeakSet,mt=function(){this.loading?this.classList.add("loading"):this.classList.remove("loading")},H=new WeakSet,ft=function(){const t=this.manifest.className||this.manifest.tagName;if(this.classList.add(t),this.manifest.template){let e=this.manifest.template;(o(this,E)&v.propOnly)==v.propOnly&&(e=e.replace(/\{\{(.+?)\}\}/g,(...i)=>`<${o(this,_)}>${i[1]}</${o(this,_)}>`)),this.innerHTML=e,(o(this,E)&v.funOnly)==v.funOnly&&m(this,G,bt).call(this)}p(this,R,!0)},T=new WeakSet,Q=function(t){return typeof t=="object"?(Object.keys(t).forEach(e=>{t[e]=m(this,T,Q).call(this,t[e])}),new Proxy(t,{set:(e,i,n)=>(e[i]=m(this,T,Q).call(this,n),m(this,F,ut).call(this),!0)})):t},$=new WeakMap,F=new WeakSet,ut=function(){o(this,$)||(p(this,$,!0),rt(()=>{m(this,X,it).call(this),p(this,$,!1)}))},X=new WeakSet,it=function(){["s-value","s-src"].forEach(i=>{m(this,k,wt).call(this,i)}),this.querySelectorAll(o(this,_)).forEach(i=>{const n=m(this,Y,st).call(this,i.origin);String(n)!==i.innerHTML&&(i.innerHTML=n)})},k=new WeakSet,wt=function(t){this.querySelectorAll(`[${t}]`).forEach(i=>{const n=i.getAttribute(t),a=t.replace("s-",""),l=m(this,Y,st).call(this,n);l!==i[a]&&(i[a]=l)})},Y=new WeakSet,st=function(t){try{return t.split(".").reduce((e,i)=>e[i],this.$data)}catch(e){console.error(e);return}},J=new WeakSet,yt=function(t,e){let i=this.$data,n=t.split(".");for(let a=0;a<n.length;a++){const l=n[a];a==n.length-1?i[l]=e:i=i[l]}},G=new WeakSet,bt=function(){this.querySelectorAll("*").forEach(e=>{e.$this||(e.$this=this,e.$set=(i,n)=>{m(this,J,yt).call(this,i,n)})})},P=new WeakMap,S=new WeakSet,A=async function(){o(this,R)&&(o(this,P)==="initing"||o(this,P)==="inited"||this.isReady()&&(p(this,P,"initing"),this.loading=!0,await this.onInit(),this.loading=!1,p(this,P,"inited"),this.afterInit()))};const Tt="",xt=r=>{let s={};return["left","top","right","bottom","width","height","margin","margin-left","margin-top","margin-right","margin-bottom","padding","padding-left","padding-top","padding-right","padding-bottom","z-index"].forEach(e=>{typeof r[e]=="number"?s[e]=r[e]+"px":typeof r[e]<"u"&&(s[e]=r[e])}),s},Z=r=>{let s="";for(const t in r)r.hasOwnProperty(t)&&(s+=`${t}:${r[t]};`);return s};var zt=Object.defineProperty,Et=Object.getOwnPropertyDescriptor,Pt=(r,s,t,e)=>{for(var i=e>1?void 0:e?Et(s,t):s,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(e?a(s,t,i):a(i))||i);return e&&i&&zt(s,t,i),i};h.WidgetManager=(ht=class extends at{constructor(){super();d(this,K)}async onInit(){this.config.forEach(t=>{this.addWidget(t)})}addWidget(t){t=m(this,K,vt).call(this,t);try{if(t.inPanel){const e=this.createIcon(t);this.appendChild(e)}else{const e=this.createWidget(t);this.appendChild(e)}}catch(e){console.error(e)}}createIcon(t){const e=document.createElement("webgis-widget-icon");e.startup({mapView:this.mapView,map:this.map,config:t,mapConfig:this.mapConfig});const{width:i,height:n,...a}=t.position,l=Z(a);return e.setAttribute("style",l),e.title=t.label||t.tagName,e}createWidget(t){if(!t.tagName)throw new Error("tagName不能为空");const e=document.createElement(t.tagName);if(!e.startup)throw new Error(`没有找到tagName为${t.tagName}的组件`);e.startup({mapView:this.mapView,map:this.map,config:t.config,mapConfig:this.mapConfig});const i=t.position,n=Z(i);return e.setAttribute("style",n),e.style.zIndex=e.style.zIndex||"1",e}},K=new WeakSet,vt=function(t){return t=Object.assign({label:"",tagName:"",position:{},inPanel:!1,icon:"",config:{}},t),t.position=Object.assign({left:"auto",right:"auto",bottom:"auto",top:"auto"},xt(t.position)),t},ht),h.WidgetManager=Pt([ot({tagName:"webgis-widget-manager",className:"webgis-widget-manager",hasConfig:!0})],h.WidgetManager);const $t="",Ct=`<div>\r
    <!-- 图标 -->\r
    <div class="widget-icon" onclick="$this.iconClick(event)">\r
        <img s-src="icon">\r
    </div>\r
    <!-- 组件 -->\r
    <div class="widget-panel">\r
        <!-- 标题 -->\r
        <div class="widget-header">\r
            <div class="widget-label"></div>\r
            <div class="close-btn" onclick="$this.closeWidget()"></div>\r
        </div>\r
        <!-- 内容 -->\r
        <div class="widget-content"></div>\r
    </div>\r
</div>`;class b{static getPosition(s,t){var e=this.getBoundingClientRect(s);if(e={x:e.left,y:e.top,w:e.right-e.left,h:e.bottom-e.top},t){var i=this.docScroll(s.ownerDocument);e.x+=i.x,e.y+=i.y}return e}static getBoundingClientRect(s){var t={x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0},e;try{e=s.getBoundingClientRect()}catch{return t}return typeof e.left>"u"?t:e}static docScroll(s){var t=s.parentWindow||s.defaultView;return"pageXOffset"in t?{x:t.pageXOffset,y:t.pageYOffset}:s.documentElement?{x:s.documentElement.scrollLeft,y:s.documentElement.scrollTop}:{x:0,y:0}}static getPadBorderExtents(s){let t=window.getComputedStyle(s);return{l:parseInt(t.paddingLeft)+parseInt(t.borderLeft),t:parseInt(t.paddingTop)+parseInt(t.borderTop),r:parseInt(t.paddingRight)+parseInt(t.borderRight),b:parseInt(t.paddingBottom)+parseInt(t.borderBottom),w:parseInt(t.paddingLeft)+parseInt(t.borderLeft)+parseInt(t.paddingRight)+parseInt(t.borderRight),h:parseInt(t.paddingTop)+parseInt(t.borderTop)+parseInt(t.paddingBottom)+parseInt(t.borderBottom)}}static getMarginExtents(s){let t=window.getComputedStyle(s);return{l:parseInt(t.marginLeft),t:parseInt(t.marginTop),r:parseInt(t.marginRight),b:parseInt(t.marginBottom),w:parseInt(t.marginLeft)+parseInt(t.marginRight),h:parseInt(t.marginTop)+parseInt(t.marginBottom)}}}const Bt="";class It{constructor(s,t){w(this,"domNode");w(this,"container");w(this,"minSize",{w:20,h:20});w(this,"constrainMax",!1);w(this,"maxSize",{w:0,h:0});w(this,"fixedAspect",!1);w(this,"startSize");w(this,"_resizeX",!0);w(this,"_resizeY",!0);w(this,"startPoint",{x:0,y:0});w(this,"startPosition");w(this,"_isSizing",!1);this.container=s,t&&(this.minSize=t.minSize||this.minSize,this.maxSize=t.maxSize||this.maxSize,this.constrainMax=t.constrainMax||this.constrainMax,this.fixedAspect=t.fixedAspect||this.fixedAspect),this.init()}init(){this.domNode=document.createElement("div"),this.domNode.className="resize-handle",this.container.appendChild(this.domNode),this.domNode.addEventListener("mousedown",s=>this._beginSizing(s))}_beginSizing(s){if(s.preventDefault(),this._isSizing)return;this.startPoint={x:s.clientX,y:s.clientY};let t=b.getPosition(this.container,!0);this.startPosition={l:t.x,t:t.y};let e=b.getPadBorderExtents(this.container),i=b.getMarginExtents(this.container);this.startSize={w:this.container.offsetWidth,h:this.container.offsetHeight,pbw:e.w,pbh:e.h,mw:i.w,mh:i.h},this._isSizing=!0,this._endSizing=this._endSizing.bind(this),this._updateSizing=this._updateSizing.bind(this),document.addEventListener("mouseup",this._endSizing),document.addEventListener("mousemove",this._updateSizing),s.stopPropagation()}_updateSizing(s){var t,e,i,n;if(s.preventDefault(),this._isSizing){let a=this._getNewCoords(s,this.startPosition),l=a.w,f=a.h;l>=0&&(l=Math.max(l-((t=this.startSize)==null?void 0:t.pbw)-((e=this.startSize)==null?void 0:e.mw),0)),f>=0&&(f=Math.max(f-((i=this.startSize)==null?void 0:i.pbh)-((n=this.startSize)==null?void 0:n.mh),0)),this.container.style.width=l+"px",this.container.style.height=f+"px"}}_endSizing(s){s.preventDefault(),this._isSizing=!1,document.removeEventListener("mouseup",this._endSizing),document.removeEventListener("mousemove",this._updateSizing)}_getNewCoords(s,t){var f,z,dt,ct,gt,pt;try{if(!s.clientX||!s.clientY)return!1}catch{return!1}var e=((f=this.startPoint)==null?void 0:f.x)-s.clientX,i=((z=this.startPoint)==null?void 0:z.y)-s.clientY,n=((dt=this.startSize)==null?void 0:dt.w)-(this._resizeX?e:0),a=((ct=this.startSize)==null?void 0:ct.h)-(this._resizeY?i:0),l=this._checkConstraints(n,a);return t=t||this.startPosition,t&&this._resizeX&&(l.l=t.l+e,l.w!=n&&(l.l+=n-l.w),l.t=t.t),l.w+=(gt=this.startSize)==null?void 0:gt.pbw,l.h+=(pt=this.startSize)==null?void 0:pt.pbh,l}_checkConstraints(s,t){var f,z;if(this.minSize){var e=this.minSize;s<e.w&&(s=e.w),t<e.h&&(t=e.h)}if(this.constrainMax&&this.maxSize){var i=this.maxSize;s>i.w&&(s=i.w),t>i.h&&(t=i.h)}if(this.fixedAspect){var n=(f=this.startSize)==null?void 0:f.w,a=(z=this.startSize)==null?void 0:z.h,l=n*t-a*s;l<0?s=t*n/a:l>0&&(t=s*a/n)}return{w:s,h:t}}}var Nt=Object.defineProperty,Mt=Object.getOwnPropertyDescriptor,Ot=(r,s,t,e)=>{for(var i=e>1?void 0:e?Mt(s,t):s,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(e?a(s,t,i):a(i))||i);return e&&i&&Nt(s,t,i),i};h.WidgetIcon=(lt=class extends at{constructor(){super();d(this,u,null);d(this,x,null);d(this,B,!1);w(this,"group","default");d(this,j,{x:0,y:0});d(this,y,{x:0,y:0,w:0,h:0});d(this,C,void 0);p(this,C,new ResizeObserver(this.resize.bind(this)))}async onInit(){this.$data={icon:`${this.config.icon||"icons/default.png"}`},this.group=this.config.group||"default",this.config.position=Object.assign({width:"300px",height:"300px"},this.config.position)}initPanel(){p(this,x,this.createWidget(this.config)),p(this,u,this.getElementsByClassName("widget-panel")[0]);const{width:t,height:e}=this.config.position,i=Z({width:t,height:e});o(this,u).setAttribute("style",i);let n=o(this,u).getElementsByClassName("widget-label")[0];n.innerHTML=this.title,o(this,u).getElementsByClassName("widget-content")[0].appendChild(o(this,x)),o(this,u).getElementsByClassName("widget-header")[0].addEventListener("mousedown",this.onMouseDown.bind(this)),new It(o(this,u));const f=this.getPanelXY();this.setPosition(f.left,f.top)}getPanelXY(){var z;let t=((z=this.config.panel)==null?void 0:z.position)||{};const e=b.getPosition(this.parentElement,!0),i=this.getElementsByClassName("widget-icon")[0],n=b.getPosition(i,!0),a=b.getPosition(o(this,u),!0);let l,f;return t.left??!1?l=parseInt(t.left):t.right??!1?l=e.w-a.w-parseInt(t.right):n.x>e.w/2?l=n.x-a.w-5:l=n.x+n.w+5,t.top??!1?f=parseInt(t.top):t.bottom??!1?f=e.w-a.h-parseInt(t.bottom):f=n.y,{left:l,top:f}}iconClick(){o(this,B)?this.closeWidget():this.openWidget()}openWidget(){var t;this.closeOthers(),this.classList.add("webgis-widget-icon-open"),o(this,x)||this.initPanel(),(t=o(this,x))==null||t.onOpen(),p(this,B,!0),o(this,C).observe(this.parentElement)}closeWidget(){var t;this.classList.remove("webgis-widget-icon-open"),o(this,C).unobserve(this.parentElement),(t=o(this,x))==null||t.onClose(),p(this,B,!1)}closeOthers(){var e;const t=(e=this.parentNode)==null?void 0:e.querySelectorAll("webgis-widget-icon");t==null||t.forEach(i=>{this.group==i.group&&i.closeWidget()})}createWidget(t){if(!t.tagName)throw new Error("tagName不能为空");const e=document.createElement(t.tagName);if(!e.startup)throw new Error(`没有找到tagName为${t.tagName}的组件`);return e.startup({mapView:this.mapView,map:this.map,config:t.config,mapConfig:this.mapConfig}),e}destroy(){o(this,C).disconnect(),this.remove()}resize(){p(this,y,b.getPosition(o(this,u),!0)),this.setPosition(o(this,y).x,o(this,y).y)}onMouseDown(t){t.preventDefault(),o(this,u).classList.add("panel-dragging"),p(this,j,{x:t.clientX,y:t.clientY}),p(this,y,b.getPosition(o(this,u),!0)),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}onMouseMove(t){t.preventDefault();let e=o(this,j).x-t.clientX,i=o(this,j).y-t.clientY,n=o(this,y).x-e,a=o(this,y).y-i;this.setPosition(n,a)}setPosition(t,e){let i=this.checkConstraints(t,e),n=b.getPosition(this,!0);o(this,u).style.left=i.x-n.x+"px",o(this,u).style.top=i.y-n.y+"px"}onMouseUp(t){t.preventDefault(),o(this,u).classList.remove("panel-dragging"),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}checkConstraints(t,e){const i=b.getPosition(this.parentElement,!0),n=i.x,a=i.w-o(this,y).w,l=i.y,f=i.h-o(this,y).h;return t=Math.max(n,Math.min(a,t)),e=Math.max(l,Math.min(f,e)),{x:t,y:e}}},u=new WeakMap,x=new WeakMap,B=new WeakMap,j=new WeakMap,y=new WeakMap,C=new WeakMap,lt),h.WidgetIcon=Ot([ot({tagName:"webgis-widget-icon",className:"webgis-widget-icon",template:Ct,hasConfig:!0})],h.WidgetIcon),q().then(()=>{console.log("初始化完成")}),h.BaseLabel=nt,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=main.umd.cjs.map
